
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Interactive Prediction Tracker - Advanced Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --bg-color: #ecf0f1;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .stocks-sidebar {
            width: 300px;
            flex-shrink: 0;
        }

        .chart-section {
            flex: 1;
            min-width: 0;
        }

        .header {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .nav-links {
            margin: 20px 0;
        }

        .nav-links a, .btn {
            background: var(--secondary-color);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            margin: 0 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-block;
        }

        .nav-links a:hover, .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .controls-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: center;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 10px 20px;
            border: 2px solid var(--secondary-color);
            background: transparent;
            color: var(--secondary-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: var(--secondary-color);
            color: white;
        }

        .stock-selector {
            padding: 10px;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            font-size: 16px;
            min-width: 200px;
        }

        .lock-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .lock-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lock-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
            margin: 20px 0;
        }

        .chart-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid var(--secondary-color);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .predictions-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .prediction-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .prediction-card:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .prediction-card.selected {
            border: 3px solid var(--secondary-color);
            box-shadow: 0 8px 32px rgba(52, 152, 219, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stock-symbol {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .lock-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .locked {
            background: #ffd700;
            color: #8b6914;
        }

        .unlocked {
            background: #d4edda;
            color: #155724;
        }

        .card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .detail-item {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .detail-value {
            font-weight: bold;
            color: var(--primary-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--secondary-color);
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .stocks-sidebar {
                width: 100%;
                order: 2;
            }

            .chart-section {
                order: 1;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
            }

            .view-toggle {
                justify-content: center;
            }

            .chart-wrapper {
                height: 400px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .predictions-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Interactive Prediction Tracker</h1>
            <p>Advanced Charts with Lock Feature & Progressive Tracking</p>

            <div class="nav-links">
                <a href="/">üè† Main Dashboard</a>
                <a href="/analysis">üìà Analysis</a>
                <a href="/lookup">üîç Stock Lookup</a>
                <a href="/prediction-tracker">üìã Simple Tracker</a>
                <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
            </div>
        </div>

        <div class="controls-section">
            <div class="control-group">
                <div class="view-toggle">
                    <button class="view-btn active" data-view="5d" onclick="switchView('5d')">üìç 5D View</button>
                    <button class="view-btn" data-view="30d" onclick="switchView('30d')">üìç 30D View</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="stocks-sidebar">
                <div class="controls-section" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary-color);">üìä Select Stock</h3>
                    <select id="stockSelector" class="stock-selector" onchange="selectStock()" style="width: 100%; margin-bottom: 15px;">
                        <option value="">Select a stock to chart...</option>
                    </select>
                    
                    <div class="lock-controls" style="justify-content: center; margin-bottom: 15px;">
                        <div class="lock-toggle">
                            <input type="checkbox" id="lockToggle" class="lock-checkbox" onchange="toggleLock()">
                            <label for="lockToggle">üîê Lock Prediction</label>
                        </div>
                    </div>
                </div>

                <div id="loadingIndicator" class="loading" style="padding: 20px;">
                    <h4>‚è≥ Loading...</h4>
                    <p>Fetching stock data...</p>
                </div>

                <div id="predictionsGrid" class="predictions-grid" style="display: none;">
                    <!-- Dynamic prediction cards will be loaded here -->
                </div>

                <div id="noData" class="no-data" style="display: none; padding: 20px;">
                    <h4>üìã No Data</h4>
                    <p>No predictions available.</p>
                </div>
            </div>

            <div class="chart-section">
                <div id="chartContainer" class="chart-container" style="display: none;">
                    <h3 id="chartTitle">üìà Stock Prediction Chart</h3>
                    <div class="chart-wrapper">
                        <canvas id="predictionChart"></canvas>
                    </div>
                    
                    <div class="chart-info">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Current Day</div>
                                <div id="currentDay" class="info-value">--</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Prediction Change</div>
                                <div id="predictionChange" class="info-value">--</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Target Progress</div>
                                <div id="targetProgress" class="info-value">--</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Lock Status</div>
                                <div id="lockStatus" class="info-value">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="chartPlaceholder" class="chart-container" style="display: block;">
                    <div style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                        <h3>üìä Interactive Chart View</h3>
                        <p>Select a stock from the left sidebar to view its prediction chart</p>
                        <p>Charts show original predictions, actual progress, and updated predictions</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentView = '5d';
        let selectedStock = null;
        let predictionData = {};
        let chart = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Interactive Prediction Tracker initialized');
            loadPredictionData();
        });

        function switchView(view) {
            currentView = view;
            
            // Update button appearance
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            
            // Update chart if stock is selected
            if (selectedStock) {
                updateChart();
            }
            
            console.log(`Switched to ${view} view`);
        }

        function selectStock() {
            const selector = document.getElementById('stockSelector');
            selectedStock = selector.value;
            
            if (selectedStock && predictionData[selectedStock]) {
                showChart();
                updateChart();
                updateLockToggle();
                highlightSelectedCard();
            } else {
                hideChart();
            }
        }

        function toggleLock() {
            if (!selectedStock) return;
            
            const lockToggle = document.getElementById('lockToggle');
            const isLocked = lockToggle.checked;
            const lockKey = `locked_${currentView}`;
            
            // Update prediction data
            if (!predictionData[selectedStock]) {
                predictionData[selectedStock] = {};
            }
            
            predictionData[selectedStock][lockKey] = isLocked;
            predictionData[selectedStock][`lock_date_${currentView}`] = isLocked ? new Date().toISOString().split('T')[0] : null;
            
            // Save to backend
            saveLockStatus(selectedStock, currentView, isLocked);
            
            // Update UI
            updateLockStatus();
            updatePredictionCards();
            
            console.log(`${isLocked ? 'Locked' : 'Unlocked'} ${selectedStock} for ${currentView}`);
        }

        function refreshData() {
            console.log('Refreshing prediction data...');
            loadPredictionData();
        }

        function loadPredictionData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const predictionsGrid = document.getElementById('predictionsGrid');
            const noData = document.getElementById('noData');

            // Show loading
            loadingIndicator.style.display = 'block';
            predictionsGrid.style.display = 'none';
            noData.style.display = 'none';
            hideChart();

            // Load enhanced prediction data
            Promise.all([
                fetch('/api/predictions-tracker').then(response => response.json()),
                fetch('/api/interactive-tracker-data').then(response => response.json().catch(() => ({status: 'no_data'})))
            ])
            .then(([basicData, enhancedData]) => {
                console.log('Basic prediction data:', basicData);
                console.log('Enhanced tracker data:', enhancedData);

                // Process and merge data
                processTrackingData(basicData, enhancedData);
                
                loadingIndicator.style.display = 'none';
                
                if (Object.keys(predictionData).length > 0) {
                    populateStockSelector();
                    updatePredictionCards();
                    predictionsGrid.style.display = 'grid';
                } else {
                    noData.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading prediction data:', error);
                loadingIndicator.style.display = 'none';
                noData.style.display = 'block';
            });
        }

        function processTrackingData(basicData, enhancedData) {
            predictionData = {};
            
            // Process basic prediction data
            if (basicData.status === 'success' && basicData.predictions) {
                basicData.predictions.forEach(pred => {
                    const symbol = pred.symbol;
                    if (!predictionData[symbol]) {
                        predictionData[symbol] = {
                            symbol: symbol,
                            current_price: pred.current_price || 0,
                            confidence: pred.confidence || 0,
                            score: pred.score || 0,
                            timestamp: pred.timestamp
                        };
                    }
                    
                    // Generate sample tracking data for demo
                    generateSampleTrackingData(symbol, pred);
                });
            }
            
            // Merge enhanced data if available
            if (enhancedData.status === 'success' && enhancedData.tracking_data) {
                Object.assign(predictionData, enhancedData.tracking_data);
            }
        }

        function generateSampleTrackingData(symbol, pred) {
            const basePrice = pred.current_price || 100;
            const pred5d = pred.pred_5d || 0;
            const pred30d = pred.predicted_1mo || 0;
            
            // Generate 5D data
            const predicted5d = [];
            const actual5d = [basePrice, null, null, null, null];
            const updated5d = [null, null, null, null, null];
            
            for (let i = 0; i < 5; i++) {
                predicted5d.push(basePrice * (1 + (pred5d/100) * (i+1)/5));
            }
            
            // Simulate some actual progress (2 days)
            if (Math.random() > 0.5) {
                actual5d[1] = basePrice * (1 + (Math.random() - 0.5) * 0.02);
                if (Math.random() > 0.7) {
                    actual5d[2] = actual5d[1] * (1 + (Math.random() - 0.5) * 0.02);
                }
            }
            
            // Generate 30D data (simplified)
            const predicted30d = [];
            const actual30d = Array(30).fill(null);
            const updated30d = Array(30).fill(null);
            
            for (let i = 0; i < 30; i++) {
                predicted30d.push(basePrice * (1 + (pred30d/100) * (i+1)/30));
            }
            actual30d[0] = basePrice;
            
            predictionData[symbol] = {
                ...predictionData[symbol],
                predicted_5d: predicted5d,
                predicted_30d: predicted30d,
                actual_progress_5d: actual5d,
                actual_progress_30d: actual30d,
                updated_prediction_5d: updated5d,
                updated_prediction_30d: updated30d,
                changed_on_5d: null,
                changed_on_30d: null,
                locked_5d: false,
                locked_30d: false,
                lock_date_5d: null,
                lock_date_30d: null
            };
        }

        function populateStockSelector() {
            const selector = document.getElementById('stockSelector');
            selector.innerHTML = '<option value="">Select a stock to chart...</option>';
            
            Object.keys(predictionData).forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                selector.appendChild(option);
            });
        }

        function updatePredictionCards() {
            const grid = document.getElementById('predictionsGrid');
            
            grid.innerHTML = Object.keys(predictionData).map(symbol => {
                const data = predictionData[symbol];
                const locked5d = data.locked_5d || false;
                const locked30d = data.locked_30d || false;
                
                return `
                    <div class="prediction-card ${selectedStock === symbol ? 'selected' : ''}" 
                         onclick="selectStockFromCard('${symbol}')">
                        <div class="card-header">
                            <div class="stock-symbol">${symbol}</div>
                            <div class="lock-status ${locked5d || locked30d ? 'locked' : 'unlocked'}">
                                ${locked5d || locked30d ? 'üîí Locked' : 'üîì Unlocked'}
                            </div>
                        </div>
                        <div class="card-details">
                            <div class="detail-item">
                                <div class="detail-label">Current Price</div>
                                <div class="detail-value">‚Çπ${(data.current_price || 0).toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">5D Progress</div>
                                <div class="detail-value">${getActualDaysCount(data.actual_progress_5d)}/5</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">30D Progress</div>
                                <div class="detail-value">${getActualDaysCount(data.actual_progress_30d)}/30</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Confidence</div>
                                <div class="detail-value">${(data.confidence || 0).toFixed(0)}%</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectStockFromCard(symbol) {
            const selector = document.getElementById('stockSelector');
            selector.value = symbol;
            selectStock();
        }

        function highlightSelectedCard() {
            document.querySelectorAll('.prediction-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            if (selectedStock) {
                const selectedCard = Array.from(document.querySelectorAll('.prediction-card'))
                    .find(card => card.textContent.includes(selectedStock));
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }
            }
        }

        function showChart() {
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('chartPlaceholder').style.display = 'none';
        }

        function hideChart() {
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('chartPlaceholder').style.display = 'block';
        }

        function updateChart() {
            if (!selectedStock || !predictionData[selectedStock]) return;
            
            const data = predictionData[selectedStock];
            const chartTitle = document.getElementById('chartTitle');
            chartTitle.textContent = `üìà ${selectedStock} - ${currentView.toUpperCase()} Prediction Tracking`;
            
            // Prepare chart data
            const days = currentView === '5d' ? 5 : 30;
            
            // Generate actual date labels
            const startDate = new Date(data.start_date || new Date());
            const labels = Array.from({length: days}, (_, i) => {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                return date.toLocaleDateString('en-IN', { 
                    month: 'short', 
                    day: 'numeric' 
                });
            });
            
            const predictedKey = `predicted_${currentView}`;
            const actualKey = `actual_progress_${currentView}`;
            const updatedKey = `updated_prediction_${currentView}`;
            
            const predictedData = data[predictedKey] || Array(days).fill(null);
            const actualData = data[actualKey] || Array(days).fill(null);
            const updatedData = data[updatedKey] || Array(days).fill(null);
            
            // Destroy existing chart
            if (chart) {
                chart.destroy();
            }
            
            // Create new chart
            const ctx = document.getElementById('predictionChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Original Prediction',
                            data: predictedData,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Actual Price',
                            data: actualData,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            spanGaps: false
                        },
                        {
                            label: 'Updated Prediction',
                            data: updatedData,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderDash: [3, 3],
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            spanGaps: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return value !== null ? `${context.dataset.label}: ‚Çπ${value.toFixed(2)}` : null;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price (‚Çπ)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value.toFixed(0);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverBackgroundColor: '#ffffff',
                            hoverBorderWidth: 3
                        }
                    }
                }
            });
            
            updateChartInfo();
        }

        function updateChartInfo() {
            if (!selectedStock || !predictionData[selectedStock]) return;
            
            const data = predictionData[selectedStock];
            const actualKey = `actual_progress_${currentView}`;
            const changedKey = `changed_on_${currentView}`;
            const lockKey = `locked_${currentView}`;
            
            const actualData = data[actualKey] || [];
            const actualDays = getActualDaysCount(actualData);
            const totalDays = currentView === '5d' ? 5 : 30;
            const changedOn = data[changedKey];
            const isLocked = data[lockKey] || false;
            
            document.getElementById('currentDay').textContent = `${actualDays} of ${totalDays}`;
            document.getElementById('predictionChange').textContent = changedOn ? `YES on Day ${changedOn + 1}` : 'NO';
            document.getElementById('targetProgress').textContent = `${Math.round((actualDays / totalDays) * 100)}%`;
            document.getElementById('lockStatus').textContent = isLocked ? 'üîí Locked' : 'üîì Unlocked';
        }

        function updateLockToggle() {
            if (!selectedStock || !predictionData[selectedStock]) return;
            
            const lockToggle = document.getElementById('lockToggle');
            const lockKey = `locked_${currentView}`;
            const isLocked = predictionData[selectedStock][lockKey] || false;
            
            lockToggle.checked = isLocked;
        }

        function updateLockStatus() {
            updateChartInfo();
            updatePredictionCards();
        }

        function getActualDaysCount(actualData) {
            if (!actualData) return 0;
            return actualData.filter(val => val !== null && val !== undefined).length;
        }

        function saveLockStatus(symbol, period, isLocked) {
            // Save lock status to backend
            fetch('/api/update-lock-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    symbol: symbol,
                    period: period,
                    locked: isLocked,
                    timestamp: new Date().toISOString()
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Lock status saved:', data);
            })
            .catch(error => {
                console.error('Error saving lock status:', error);
            });
        }
    </script>
</body>
</html>
