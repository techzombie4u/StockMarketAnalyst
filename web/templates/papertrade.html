
{% extends "_layout.html" %}

{% block title %}Paper Trade{% endblock %}

{% block extra_css %}
<style>
.papertrade-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 16px;
}

.portfolio-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.portfolio-card {
    background: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.portfolio-card h3 {
    color: #94a3b8;
    font-size: 14px;
    font-weight: 500;
    margin: 0 0 8px 0;
}

.portfolio-card .value {
    color: #e2e8f0;
    font-size: 28px;
    font-weight: 600;
    margin: 0;
}

.portfolio-card .change {
    font-size: 14px;
    margin-top: 4px;
}

.positive { color: #22c55e; }
.negative { color: #ef4444; }
.neutral { color: #94a3b8; }

.trade-form {
    background: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 16px;
    align-items: end;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    color: #94a3b8;
    font-size: 14px;
    margin-bottom: 8px;
}

.form-group input,
.form-group select {
    background: #111827;
    border: 1px solid #1e293b;
    border-radius: 6px;
    color: #e2e8f0;
    padding: 12px;
    font-size: 14px;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #22c55e;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: #22c55e;
    color: white;
}

.btn-primary:hover {
    background: #16a34a;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.live-price {
    background: #111827;
    border: 1px solid #1e293b;
    border-radius: 6px;
    padding: 12px;
    margin-left: 8px;
    font-size: 14px;
    color: #e2e8f0;
    min-width: 120px;
}

.positions-table,
.orders-table {
    background: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 8px;
    margin-bottom: 24px;
    overflow: hidden;
}

.table-header {
    background: #1e293b;
    padding: 16px 20px;
    border-bottom: 1px solid #334155;
}

.table-header h2 {
    color: #e2e8f0;
    margin: 0;
    font-size: 18px;
}

.table-content {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    text-align: left;
    padding: 12px 16px;
    border-bottom: 1px solid #1e293b;
}

th {
    background: #111827;
    color: #94a3b8;
    font-weight: 500;
    font-size: 12px;
    text-transform: uppercase;
}

td {
    color: #e2e8f0;
    font-size: 14px;
}

.status-executing { color: #f59e0b; }
.status-executed { color: #22c55e; }
.status-failed { color: #ef4444; }

.close-btn {
    padding: 6px 12px;
    font-size: 12px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #94a3b8;
}

.error {
    background: #7f1d1d;
    border: 1px solid #dc2626;
    color: #fca5a5;
    padding: 12px;
    border-radius: 6px;
    margin: 16px 0;
}

.success {
    background: #14532d;
    border: 1px solid #22c55e;
    color: #86efac;
    padding: 12px;
    border-radius: 6px;
    margin: 16px 0;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .portfolio-summary {
        grid-template-columns: 1fr 1fr;
    }
    
    table {
        font-size: 12px;
    }
    
    th, td {
        padding: 8px 12px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="papertrade-container">
    <!-- Portfolio Summary -->
    <div class="portfolio-summary" id="portfolioSummary">
        <div class="portfolio-card">
            <h3>Portfolio Value</h3>
            <div class="value" id="portfolioValue">₹10,00,000</div>
            <div class="change neutral" id="portfolioChange">Initial Capital</div>
        </div>
        <div class="portfolio-card">
            <h3>Total P&L</h3>
            <div class="value" id="totalPnL">₹0</div>
            <div class="change neutral" id="totalPnLPercent">0.00%</div>
        </div>
        <div class="portfolio-card">
            <h3>Open Positions</h3>
            <div class="value" id="openPositions">0</div>
            <div class="change neutral" id="positionsChange">No positions</div>
        </div>
        <div class="portfolio-card">
            <h3>Total Trades</h3>
            <div class="value" id="totalTrades">0</div>
            <div class="change neutral" id="tradesChange">Ready to trade</div>
        </div>
    </div>

    <!-- Trade Form -->
    <div class="trade-form">
        <h2 style="color: #e2e8f0; margin-bottom: 20px;">🚀 Place Trade</h2>
        <form id="tradeForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="symbol">Symbol</label>
                    <input type="text" id="symbol" name="symbol" placeholder="e.g. RELIANCE" required>
                </div>
                <div class="form-group">
                    <label for="side">Side</label>
                    <select id="side" name="side" required>
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantity">Quantity</label>
                    <input type="number" id="quantity" name="quantity" min="1" placeholder="10" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Execute Trade</button>
                </div>
            </div>
        </form>
        <div class="live-price" id="livePrice">Enter symbol for live price</div>
        <div id="tradeMessage"></div>
    </div>

    <!-- Current Positions -->
    <div class="positions-table">
        <div class="table-header">
            <h2>📊 Current Positions</h2>
        </div>
        <div class="table-content">
            <div id="positionsLoading" class="loading">Loading positions...</div>
            <table id="positionsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Quantity</th>
                        <th>Avg Price</th>
                        <th>Current Price</th>
                        <th>Position Value</th>
                        <th>P&L</th>
                        <th>P&L %</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="positionsBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Order History -->
    <div class="orders-table">
        <div class="table-header">
            <h2>📋 Order History</h2>
        </div>
        <div class="table-content">
            <div id="ordersLoading" class="loading">Loading orders...</div>
            <table id="ordersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="ordersBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
class PaperTradeManager {
    constructor() {
        this.currentSymbol = '';
        this.livePriceInterval = null;
        this.refreshInterval = null;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.loadPortfolioData();
        this.startAutoRefresh();
    }

    setupEventListeners() {
        // Trade form submission
        document.getElementById('tradeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.executeTrade();
        });

        // Symbol input for live price
        document.getElementById('symbol').addEventListener('input', (e) => {
            const symbol = e.target.value.toUpperCase();
            if (symbol && symbol.length >= 2) {
                this.currentSymbol = symbol;
                this.updateLivePrice(symbol);
            } else {
                this.clearLivePrice();
            }
        });
    }

    async updateLivePrice(symbol) {
        try {
            const response = await fetch(`/api/papertrade/live-price/${symbol}`);
            const data = await response.json();
            
            if (data.success) {
                const priceElement = document.getElementById('livePrice');
                const change = data.change || 0;
                const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';
                
                priceElement.innerHTML = `
                    <strong>₹${data.price.toFixed(2)}</strong>
                    <span class="${changeClass}">
                        ${change >= 0 ? '+' : ''}${change.toFixed(2)} (${(data.change_percent || 0).toFixed(2)}%)
                    </span>
                `;
                priceElement.className = `live-price ${changeClass}`;
            } else {
                this.clearLivePrice();
            }
        } catch (error) {
            console.error('Error fetching live price:', error);
            this.clearLivePrice();
        }
    }

    clearLivePrice() {
        document.getElementById('livePrice').innerHTML = 'Enter symbol for live price';
        document.getElementById('livePrice').className = 'live-price';
    }

    async executeTrade() {
        const form = document.getElementById('tradeForm');
        const formData = new FormData(form);
        const messageEl = document.getElementById('tradeMessage');
        
        const tradeData = {
            symbol: formData.get('symbol').toUpperCase(),
            side: formData.get('side'),
            quantity: parseInt(formData.get('quantity'))
        };

        try {
            messageEl.innerHTML = '<div class="loading">Executing trade...</div>';
            
            const response = await fetch('/api/papertrade/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(tradeData)
            });

            const result = await response.json();
            
            if (result.success) {
                messageEl.innerHTML = `
                    <div class="success">
                        ✅ Trade executed: ${tradeData.side} ${tradeData.quantity} ${tradeData.symbol} 
                        @ ₹${result.live_price.toFixed(2)}
                        (Total: ₹${result.exec_value.toFixed(2)})
                    </div>
                `;
                form.reset();
                this.clearLivePrice();
                this.loadPortfolioData(); // Refresh data
            } else {
                messageEl.innerHTML = `<div class="error">❌ ${result.error}</div>`;
            }
        } catch (error) {
            messageEl.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
        }
    }

    async loadPortfolioData() {
        try {
            // Load portfolio summary
            const portfolioResponse = await fetch('/api/papertrade/portfolio');
            const portfolioData = await portfolioResponse.json();
            
            if (portfolioData.success) {
                this.updatePortfolioSummary(portfolioData.data);
            }

            // Load positions
            const positionsResponse = await fetch('/api/papertrade/positions');
            const positionsData = await positionsResponse.json();
            
            if (positionsData.success) {
                this.updatePositionsTable(positionsData.positions);
            }

            // Load orders
            const ordersResponse = await fetch('/api/papertrade/orders?limit=20');
            const ordersData = await ordersResponse.json();
            
            if (ordersData.success) {
                this.updateOrdersTable(ordersData.orders);
            }

        } catch (error) {
            console.error('Error loading portfolio data:', error);
        }
    }

    updatePortfolioSummary(data) {
        const portfolio = data.portfolio || {};
        
        document.getElementById('portfolioValue').textContent = 
            `₹${(portfolio.current_capital || 1000000).toLocaleString('en-IN')}`;
        
        const totalPnL = portfolio.total_pnl || 0;
        document.getElementById('totalPnL').textContent = 
            `₹${totalPnL.toLocaleString('en-IN')}`;
        
        const pnlPercent = ((totalPnL / (portfolio.initial_capital || 1000000)) * 100);
        document.getElementById('totalPnLPercent').textContent = 
            `${pnlPercent.toFixed(2)}%`;
        document.getElementById('totalPnLPercent').className = 
            `change ${totalPnL > 0 ? 'positive' : totalPnL < 0 ? 'negative' : 'neutral'}`;
        
        document.getElementById('openPositions').textContent = 
            data.positions_count || 0;
        
        document.getElementById('totalTrades').textContent = 
            data.total_trades || 0;
    }

    updatePositionsTable(positions) {
        const tbody = document.getElementById('positionsBody');
        const table = document.getElementById('positionsTable');
        const loading = document.getElementById('positionsLoading');
        
        if (positions.length === 0) {
            loading.textContent = 'No positions found';
            table.style.display = 'none';
            return;
        }

        tbody.innerHTML = positions.map(pos => {
            const pnl = pos.pnl || 0;
            const pnlClass = pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : 'neutral';
            
            return `
                <tr>
                    <td><strong>${pos.symbol}</strong></td>
                    <td>${pos.quantity}</td>
                    <td>₹${pos.avg_price.toFixed(2)}</td>
                    <td>₹${(pos.current_price || 0).toFixed(2)}</td>
                    <td>₹${(pos.position_value || 0).toLocaleString('en-IN')}</td>
                    <td class="${pnlClass}">₹${pnl.toLocaleString('en-IN')}</td>
                    <td class="${pnlClass}">${(pos.pnl_percent || 0).toFixed(2)}%</td>
                    <td>
                        <button class="btn btn-danger close-btn" onclick="paperTrade.closePosition('${pos.symbol}')">
                            Close
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        loading.style.display = 'none';
        table.style.display = 'table';
    }

    updateOrdersTable(orders) {
        const tbody = document.getElementById('ordersBody');
        const table = document.getElementById('ordersTable');
        const loading = document.getElementById('ordersLoading');
        
        if (orders.length === 0) {
            loading.textContent = 'No orders found';
            table.style.display = 'none';
            return;
        }

        tbody.innerHTML = orders.map(order => {
            const timestamp = new Date(order.timestamp).toLocaleString('en-IN');
            const statusClass = `status-${order.status.toLowerCase()}`;
            
            return `
                <tr>
                    <td>${timestamp}</td>
                    <td><strong>${order.symbol}</strong></td>
                    <td class="${order.side === 'BUY' ? 'positive' : 'negative'}">${order.side}</td>
                    <td>${order.quantity}</td>
                    <td>₹${order.exec_price.toFixed(2)}</td>
                    <td>₹${order.exec_value.toLocaleString('en-IN')}</td>
                    <td class="${statusClass}">${order.status}</td>
                </tr>
            `;
        }).join('');
        
        loading.style.display = 'none';
        table.style.display = 'table';
    }

    async closePosition(symbol) {
        if (!confirm(`Close entire ${symbol} position?`)) return;
        
        try {
            const response = await fetch('/api/papertrade/close', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ symbol })
            });

            const result = await response.json();
            
            if (result.success) {
                alert(`✅ ${symbol} position closed successfully`);
                this.loadPortfolioData();
            } else {
                alert(`❌ Error: ${result.error}`);
            }
        } catch (error) {
            alert(`❌ Error closing position: ${error.message}`);
        }
    }

    startAutoRefresh() {
        // Refresh portfolio data every 30 seconds
        this.refreshInterval = setInterval(() => {
            this.loadPortfolioData();
        }, 30000);

        // Update live price every 5 seconds if symbol is selected
        this.livePriceInterval = setInterval(() => {
            if (this.currentSymbol) {
                this.updateLivePrice(this.currentSymbol);
            }
        }, 5000);
    }

    destroy() {
        if (this.refreshInterval) clearInterval(this.refreshInterval);
        if (this.livePriceInterval) clearInterval(this.livePriceInterval);
    }
}

// Initialize Paper Trade Manager
const paperTrade = new PaperTradeManager();

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    paperTrade.destroy();
});
</script>
{% endblock %}
