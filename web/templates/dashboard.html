
{% extends "_layout.html" %}

{% block title %}Dashboard - Fusion Stock Analyst{% endblock %}

{% block content %}
<div class="mb-4">
    <h2 class="text-lg font-bold mb-2">KPI Overview</h2>
    <div class="grid grid-6" id="kpi-grid">
        <div class="kpi text-center">
            <div class="text-xs muted">Prediction Accuracy</div>
            <div class="text-lg font-bold" id="kpi-accuracy">--</div>
        </div>
        <div class="kpi text-center">
            <div class="text-xs muted">Sharpe Ratio</div>
            <div class="text-lg font-bold" id="kpi-sharpe">--</div>
        </div>
        <div class="kpi text-center">
            <div class="text-xs muted">Sortino Ratio</div>
            <div class="text-lg font-bold" id="kpi-sortino">--</div>
        </div>
        <div class="kpi text-center">
            <div class="text-xs muted">Max Drawdown</div>
            <div class="text-lg font-bold" id="kpi-drawdown">--</div>
        </div>
        <div class="kpi text-center">
            <div class="text-xs muted">Win Expectancy</div>
            <div class="text-lg font-bold" id="kpi-expectancy">--</div>
        </div>
        <div class="kpi text-center">
            <div class="text-xs muted">Coverage</div>
            <div class="text-lg font-bold" id="kpi-coverage">--</div>
        </div>
    </div>
</div>

<div class="mb-4">
    <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold">Timeframe Analysis</h3>
    </div>
    <div class="chips" id="timeframe-chips">
        <div class="chip active" data-timeframe="All">All</div>
        <div class="chip" data-timeframe="30D">30D</div>
        <div class="chip" data-timeframe="15D">15D</div>
        <div class="chip" data-timeframe="10D">10D</div>
        <div class="chip" data-timeframe="5D">5D</div>
        <div class="chip" data-timeframe="3D">3D</div>
    </div>
</div>

<div class="grid grid-5 mb-4">
    <div class="card">
        <h4 class="font-bold mb-2">Pinned Items</h4>
        <div class="text-lg font-bold" id="pinned-count">--</div>
        <div class="text-xs muted">Total: <span id="pinned-total">--</span></div>
    </div>
    <div class="card">
        <h4 class="font-bold mb-2">Alerts</h4>
        <div class="text-lg font-bold" id="alerts-count">--</div>
        <div class="text-xs muted">Active alerts</div>
    </div>
    <div class="card">
        <h4 class="font-bold mb-2">Agent Insights</h4>
        <div class="text-lg font-bold" id="insights-count">--</div>
        <div class="text-xs muted">AI recommendations</div>
    </div>
    <div class="card">
        <h4 class="font-bold mb-2">Performance</h4>
        <div class="text-lg font-bold" id="performance-score">--</div>
        <div class="text-xs muted">Overall score</div>
    </div>
    <div class="card">
        <h4 class="font-bold mb-2">Market Status</h4>
        <div class="text-lg font-bold" id="market-status">--</div>
        <div class="text-xs muted">Current session</div>
    </div>
</div>

<div class="card">
    <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold">Top Signals</h3>
        <div class="toolbar">
            <button class="btn" onclick="refreshSignals()">Refresh</button>
        </div>
    </div>
    <div class="table-wrap">
        <table id="signals-table">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Product</th>
                    <th>AI Verdict</th>
                    <th>Confidence</th>
                    <th>Score</th>
                    <th>Rationale</th>
                    <th>Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="signals-tbody">
                <tr>
                    <td colspan="8" class="text-center muted">Loading signals...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let dashboardData = null;

async function loadDashboard(forceRefresh = false) {
    try {
        const url = `/api/fusion/dashboard${forceRefresh ? '?forceRefresh=true' : ''}`;
        const response = await fetch(url);
        const data = await response.json();
        
        dashboardData = data;
        updateKPIs(data);
        updatePinnedSummary(data);
        updateTopSignals(data);
        updateMetadata(data);
        
        console.log('Dashboard loaded successfully');
    } catch (error) {
        console.error('Failed to load dashboard:', error);
    }
}

function updateKPIs(data) {
    const timeframe = window.uiState?.timeframe || 'All';
    const kpis = data.timeframes?.[timeframe] || data.kpis || {};
    
    document.getElementById('kpi-accuracy').textContent = 
        (kpis.predictionAccuracy * 100).toFixed(1) + '%';
    document.getElementById('kpi-sharpe').textContent = 
        kpis.sharpe?.toFixed(2) || '--';
    document.getElementById('kpi-sortino').textContent = 
        kpis.sortino?.toFixed(2) || '--';
    document.getElementById('kpi-drawdown').textContent = 
        (kpis.maxDrawdown * 100).toFixed(1) + '%';
    document.getElementById('kpi-expectancy').textContent = 
        kpis.expectancy?.toFixed(2) || '--';
    document.getElementById('kpi-coverage').textContent = 
        (kpis.coverage * 100).toFixed(0) + '%';
}

function updatePinnedSummary(data) {
    const summary = data.pinned_summary || {};
    document.getElementById('pinned-count').textContent = summary.met || 0;
    document.getElementById('pinned-total').textContent = summary.total || 0;
    
    const alerts = data.alerts || [];
    document.getElementById('alerts-count').textContent = alerts.length;
    
    const insights = data.agent_insights || [];
    document.getElementById('insights-count').textContent = insights.length;
    
    document.getElementById('performance-score').textContent = 
        ((data.kpis?.predictionAccuracy || 0) * 100).toFixed(0) + '%';
    
    document.getElementById('market-status').textContent = 
        data.market_session || 'UNKNOWN';
}

function updateTopSignals(data) {
    const signals = data.top_signals || [];
    const tbody = document.getElementById('signals-tbody');
    
    if (signals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center muted">No signals available</td></tr>';
        return;
    }
    
    tbody.innerHTML = signals.map(signal => `
        <tr>
            <td class="font-bold">${signal.symbol}</td>
            <td>${signal.product}</td>
            <td><span class="badge badge-ok">${signal.ai_verdict_normalized}</span></td>
            <td>${(signal.confidence * 100).toFixed(0)}%</td>
            <td>${(signal.score * 100).toFixed(0)}</td>
            <td class="text-sm">${signal.rationale || 'Analysis pending'}</td>
            <td class="text-xs muted">${formatTime(signal.updated)}</td>
            <td>
                <button data-pin-symbol="${signal.symbol}">â˜†</button>
                <button data-lock-symbol="${signal.symbol}">ðŸ”“</button>
            </td>
        </tr>
    `).join('');
    
    // Update pin/lock icons
    window.uiState?.updatePinnedIcons();
    window.uiState?.updateLockedIcons();
}

function updateMetadata(data) {
    // Update last updated time or other metadata
    console.log('Last updated:', data.last_updated_utc);
    console.log('Generation time:', data.generation_time_ms + 'ms');
}

function formatTime(timestamp) {
    if (!timestamp) return '--';
    return new Date(timestamp).toLocaleTimeString();
}

async function refreshSignals() {
    await loadDashboard(true);
}

// Listen for timeframe changes
window.addEventListener('timeframeChanged', (event) => {
    if (dashboardData) {
        updateKPIs(dashboardData);
    }
});

// Load dashboard on page ready
document.addEventListener('DOMContentLoaded', () => {
    loadDashboard();
});
</script>
{% endblock %}
