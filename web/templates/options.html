
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Strategies - Fusion Stock Analyst</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
    <style>
        .options-page-container {
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            min-height: 100vh;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .page-subtitle {
            color: #888;
            font-size: 16px;
        }
        
        .timeframe-chips {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .chip {
            padding: 8px 16px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chip.active {
            background: #0066cc;
            border-color: #0066cc;
        }
        
        .chip:hover {
            background: #333;
        }
        
        .strategies-table {
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .table-header {
            background: #333;
            padding: 15px 20px;
            font-weight: bold;
            border-bottom: 1px solid #444;
        }
        
        .strategies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .strategy-card {
            background: #333;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #444;
        }
        
        .strategy-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stock-symbol {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }
        
        .verdict {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .verdict.strong-buy { background: #00c851; color: #000; }
        .verdict.buy { background: #2e7d32; color: #fff; }
        .verdict.hold { background: #ff9800; color: #000; }
        .verdict.cautious { background: #f44336; color: #fff; }
        
        .strategy-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #444;
        }
        
        .metric-label {
            color: #888;
            font-size: 14px;
        }
        
        .metric-value {
            color: #fff;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .error {
            background: #f44336;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .filters {
            background: #2a2a2a;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-label {
            color: #888;
            font-size: 14px;
        }
        
        .filter-input {
            background: #333;
            border: 1px solid #444;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00c851;
        }
        
        .status-text {
            color: #888;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="options-page-container" id="optionsPageContainer">
        <div class="page-header">
            <h1 class="page-title">Options Strategies</h1>
            <p class="page-subtitle">Short Strangle Opportunities & Analysis</p>
        </div>
        
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span class="status-text" id="statusText">Loading strategies...</span>
        </div>
        
        <div class="timeframe-chips" id="timeframeChips">
            <div class="chip active" data-timeframe="45D">45D</div>
            <div class="chip" data-timeframe="30D">30D</div>
            <div class="chip" data-timeframe="21D">21D</div>
            <div class="chip" data-timeframe="14D">14D</div>
            <div class="chip" data-timeframe="10D">10D</div>
            <div class="chip" data-timeframe="7D">7D</div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Max Breakout Probability:</label>
                <input type="range" class="filter-input" id="maxBreakoutProb" 
                       min="10" max="50" value="35" step="5">
                <span id="breakoutProbValue">35%</span>
            </div>
            <div class="filter-group">
                <label class="filter-label">
                    <input type="checkbox" id="hideEvents"> Hide Earnings Events
                </label>
            </div>
        </div>
        
        <div class="strategies-table">
            <div class="table-header">
                <span>Options Strategies</span>
                <span id="strategiesCount" style="float: right; color: #888;">Loading...</span>
            </div>
            
            <div id="strategiesContainer">
                <div class="loading">
                    <p>Loading options strategies...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class OptionsPage {
            constructor() {
                this.currentTimeframe = '45D';
                this.strategiesData = [];
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadStrategies();
            }
            
            setupEventListeners() {
                // Timeframe chips
                document.querySelectorAll('.chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentTimeframe = e.target.dataset.timeframe;
                        this.loadStrategies();
                    });
                });
                
                // Filters
                const maxBreakoutProb = document.getElementById('maxBreakoutProb');
                const breakoutProbValue = document.getElementById('breakoutProbValue');
                const hideEvents = document.getElementById('hideEvents');
                
                maxBreakoutProb.addEventListener('input', (e) => {
                    breakoutProbValue.textContent = e.target.value + '%';
                    this.filterStrategies();
                });
                
                hideEvents.addEventListener('change', () => {
                    this.filterStrategies();
                });
            }
            
            async loadStrategies() {
                try {
                    this.updateStatus('loading', 'Loading strategies...');
                    
                    const response = await fetch(`/api/options/strategies?timeframe=${this.currentTimeframe}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.strategies) {
                        this.strategiesData = data.strategies;
                        this.renderStrategies(this.strategiesData);
                        this.updateStatus('success', `Loaded ${data.strategies.length} strategies`);
                    } else {
                        throw new Error(data.error || 'No strategies returned');
                    }
                    
                } catch (error) {
                    console.error('Error loading strategies:', error);
                    this.showError(`Failed to load strategies: ${error.message}`);
                    this.updateStatus('error', 'Failed to load strategies');
                }
            }
            
            filterStrategies() {
                const maxProb = document.getElementById('maxBreakoutProb').value / 100;
                const hideEvents = document.getElementById('hideEvents').checked;
                
                let filtered = this.strategiesData.filter(strategy => {
                    if (hideEvents && strategy.event_flag === 'EARNINGS') return false;
                    if (strategy.breakout_prob > maxProb) return false;
                    return true;
                });
                
                this.renderStrategies(filtered);
                this.updateStatus('success', `Showing ${filtered.length} strategies`);
            }
            
            renderStrategies(strategies) {
                const container = document.getElementById('strategiesContainer');
                const count = document.getElementById('strategiesCount');
                
                if (!strategies || strategies.length === 0) {
                    container.innerHTML = '<div class="loading"><p>No strategies match current filters</p></div>';
                    count.textContent = '0 strategies';
                    return;
                }
                
                count.textContent = `${strategies.length} strategies`;
                
                container.innerHTML = `
                    <div class="strategies-grid">
                        ${strategies.map(strategy => this.renderStrategyCard(strategy)).join('')}
                    </div>
                `;
            }
            
            renderStrategyCard(strategy) {
                const verdictClass = strategy.verdict?.toLowerCase().replace(/\s+/g, '-') || 'hold';
                
                return `
                    <div class="strategy-card">
                        <div class="strategy-header">
                            <div class="stock-symbol">${strategy.stock || 'N/A'}</div>
                            <div class="verdict ${verdictClass}">${strategy.verdict || 'Hold'}</div>
                        </div>
                        
                        <div class="strategy-metrics">
                            <div class="metric">
                                <span class="metric-label">Spot Price:</span>
                                <span class="metric-value">₹${strategy.spot?.toFixed(2) || '0.00'}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Net Credit:</span>
                                <span class="metric-value">₹${strategy.net_credit?.toFixed(2) || '0.00'}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Call Strike:</span>
                                <span class="metric-value">₹${strategy.call?.toFixed(0) || '0'}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Put Strike:</span>
                                <span class="metric-value">₹${strategy.put?.toFixed(0) || '0'}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Days to Expiry:</span>
                                <span class="metric-value">${strategy.dte || 0}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">IV:</span>
                                <span class="metric-value">${strategy.iv?.toFixed(1) || '0.0'}%</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">ROI on Margin:</span>
                                <span class="metric-value">${strategy.roi_on_margin?.toFixed(1) || '0.0'}%</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Breakout Prob:</span>
                                <span class="metric-value">${(strategy.breakout_prob * 100)?.toFixed(1) || '0.0'}%</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Market Stability:</span>
                                <span class="metric-value">${strategy.market_stability || 'Med'}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Event Risk:</span>
                                <span class="metric-value">${strategy.event || '—'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            updateStatus(type, message) {
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                
                dot.style.background = type === 'success' ? '#00c851' : 
                                      type === 'error' ? '#f44336' : '#ff9800';
                text.textContent = message;
            }
            
            showError(message) {
                const container = document.getElementById('strategiesContainer');
                container.innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${message}
                        <br><br>
                        <button onclick="optionsPage.loadStrategies()" style="background: #333; color: #fff; border: 1px solid #666; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // Initialize the page
        const optionsPage = new OptionsPage();
    </script>
</body>
</html>
