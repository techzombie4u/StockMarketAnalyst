<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Strategies - Fusion Stock Analyst</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            min-height: 100vh;
        }

        .header {
            margin-bottom: 30px;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .timeframe-btn {
            padding: 8px 16px;
            background: #333;
            border: 1px solid #555;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .timeframe-btn.active {
            background: #0066cc;
            border-color: #0066cc;
        }

        .timeframe-btn:hover {
            background: #444;
        }

        .status {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 6px;
            background: #2a2a2a;
        }

        .strategies-table {
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-header {
            background: #333;
            padding: 15px;
            font-weight: bold;
            border-bottom: 1px solid #555;
        }

        .table-content {
            padding: 20px;
        }

        .strategy-row {
            background: #333;
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #555;
        }

        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stock-symbol {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .verdict {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .verdict-strong-buy { background: #00c851; color: #000; }
        .verdict-buy { background: #2e7d32; color: #fff; }
        .verdict-hold { background: #ff9800; color: #000; }
        .verdict-cautious { background: #f44336; color: #fff; }
        .verdict-avoid { background: #8b0000; color: #fff; }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #555;
        }

        .metric-label {
            color: #aaa;
        }

        .metric-value {
            font-weight: bold;
            color: #fff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .error {
            background: #8b0000;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .refresh-btn {
            background: #0066cc;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        }

        .refresh-btn:hover {
            background: #0052a3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Options Strategies</h1>
            <p class="subtitle">Real-time Short Strangle Analysis</p>
        </div>

        <div class="controls">
            <button class="timeframe-btn active" data-timeframe="45D">45 Days</button>
            <button class="timeframe-btn" data-timeframe="30D">30 Days</button>
            <button class="timeframe-btn" data-timeframe="21D">21 Days</button>
            <button class="timeframe-btn" data-timeframe="14D">14 Days</button>
            <button class="timeframe-btn" data-timeframe="10D">10 Days</button>
            <button class="timeframe-btn" data-timeframe="7D">7 Days</button>
            <button class="refresh-btn" onclick="loadStrategies()">Refresh Data</button>
        </div>

        <div class="status" id="status">
            <span id="status-text">Loading strategies...</span>
        </div>

        <div class="strategies-table">
            <div class="table-header">
                Options Strategies (<span id="count">0</span>)
            </div>
            <div class="table-content" id="strategies-container">
                <div class="loading">Loading options strategies...</div>
            </div>
        </div>
    </div>

    <script>
        let currentTimeframe = '45D';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadStrategies();

            // Auto-refresh every 30 seconds
            setInterval(loadStrategies, 30000);
        });

        function setupEventListeners() {
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTimeframe = this.dataset.timeframe;
                    loadStrategies();
                });
            });
        }

        async function loadStrategies() {
            try {
                updateStatus('Loading strategies...', 'info');

                const response = await fetch(`/api/options/strategies?timeframe=${currentTimeframe}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success && data.strategies) {
                    renderStrategies(data.strategies);
                    updateStatus(`Loaded ${data.strategies.length} strategies successfully`, 'success');
                } else {
                    throw new Error(data.error || 'No strategies data received');
                }

            } catch (error) {
                console.error('Error loading strategies:', error);
                showError(`Failed to load strategies: ${error.message}`);
                updateStatus('Error loading strategies', 'error');
            }
        }

        function renderStrategies(strategies) {
            const container = document.getElementById('strategies-container');
            const countElement = document.getElementById('count');

            if (!strategies || strategies.length === 0) {
                container.innerHTML = '<div class="loading">No strategies available for the selected timeframe</div>';
                countElement.textContent = '0';
                return;
            }

            countElement.textContent = strategies.length;

            container.innerHTML = strategies.map(strategy => renderStrategy(strategy)).join('');
        }

        function renderStrategy(strategy) {
            const verdictClass = (strategy.verdict || 'hold').toLowerCase().replace(/\s+/g, '-');

            return `
                <div class="strategy-row">
                    <div class="strategy-header">
                        <div class="stock-symbol">${strategy.stock || 'N/A'}</div>
                        <div class="verdict verdict-${verdictClass}">${strategy.verdict || 'Hold'}</div>
                    </div>

                    <div class="metrics-grid">
                        <div class="metric">
                            <span class="metric-label">Spot Price:</span>
                            <span class="metric-value">₹${formatNumber(strategy.spot)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Call Strike:</span>
                            <span class="metric-value">₹${formatNumber(strategy.call)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Put Strike:</span>
                            <span class="metric-value">₹${formatNumber(strategy.put)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Net Credit:</span>
                            <span class="metric-value">₹${formatNumber(strategy.net_credit)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Days to Expiry:</span>
                            <span class="metric-value">${strategy.dte || 0}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">IV:</span>
                            <span class="metric-value">${formatPercent(strategy.iv)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">ROI on Margin:</span>
                            <span class="metric-value">${formatPercent(strategy.roi_on_margin)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Breakout Probability:</span>
                            <span class="metric-value">${formatPercent(strategy.breakout_prob * 100)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Market Stability:</span>
                            <span class="metric-value">${strategy.market_stability || 'Medium'}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Event Risk:</span>
                            <span class="metric-value">${strategy.event || 'None'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatNumber(value) {
            if (value === null || value === undefined) return '0.00';
            return parseFloat(value).toFixed(2);
        }

        function formatPercent(value) {
            if (value === null || value === undefined) return '0.0';
            return parseFloat(value).toFixed(1);
        }

        function updateStatus(message, type) {
            const statusText = document.getElementById('status-text');
            const status = document.getElementById('status');

            statusText.textContent = message;

            // Reset classes
            status.className = 'status';

            if (type === 'success') {
                status.style.background = '#1b5e20';
            } else if (type === 'error') {
                status.style.background = '#8b0000';
            } else {
                status.style.background = '#2a2a2a';
            }
        }

        function showError(message) {
            const container = document.getElementById('strategies-container');
            container.innerHTML = `
                <div class="error">
                    <strong>Error:</strong> ${message}
                    <br><br>
                    <button onclick="loadStrategies()" class="refresh-btn">Try Again</button>
                </div>
            `;
        }
    </script>
</body>
</html>