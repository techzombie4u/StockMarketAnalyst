
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Trade - Tabbed Auto + MiniDash</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #0b1220; color: white; overflow-x: auto; }
        #root { min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useEffect, useMemo, useState } = React;

        // Theme constants
        const T = {
            bg: "bg-[#0b1220]",
            surface: "bg-[#111a2e]", 
            border: "border border-white/10",
            text: "text-white/90",
            textDim: "text-white/60",
        };

        const clsx = (...a) => a.filter(Boolean).join(" ");
        const fmtINR = (n) => new Intl.NumberFormat("en-IN", { maximumFractionDigits: 2 }).format(Number(n || 0));
        const todayYMD = () => new Date().toISOString().slice(0,10);
        const ymd = (d) => d.toISOString().slice(0,10);

        async function safeFetch(url, opts = {}, timeoutMs = 8000) {
            const ctrl = new AbortController();
            const t = setTimeout(() => ctrl.abort(), timeoutMs);
            try {
                const res = await fetch(url, { ...opts, signal: ctrl.signal });
                clearTimeout(t);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (e) {
                clearTimeout(t);
                throw e;
            }
        }

        // Mock data constants
        const MOCK = {
            portfolio: { current_capital: 1000000, total_pnl: 0, positions_count: 0, total_position_value: 0, sharpe_3m: 0, sortino_3m: 0, win_rate: 0, max_dd: 0 },
            positions: [],
            orders: [],
        };

        const LOTS = { RELIANCE: 505, TCS: 150, INFY: 300, ITC: 3200, HDFCBANK: 550, NIFTY: 50, BANKNIFTY: 15 };

        function genChain(symbol) {
            const lot = LOTS[symbol] || 100;
            const spot = 1200 + (Math.abs((symbol||'').split('').reduce((a,c)=>a+c.charCodeAt(0),0)) % 1000);
            const expiries = [];
            const base = new Date();
            for (let i = 0; i < 6; i++) {
                const d = new Date(base);
                d.setDate(d.getDate() + ((4 - d.getDay() + 7) % 7) + i * 7);
                expiries.push(ymd(d));
            }
            const step = spot < 1000 ? 10 : 20;
            const strikes = Array.from({length: 17}, (_, k) => Math.round((spot - 8 * step) + k * step));
            const ltp = (k, type) => Math.max(1, (type === 'CE' ? Math.max(0, spot - k) / 2 : Math.max(0, k - spot) / 2) + 12 + Math.random() * 8);
            return { lotSize: lot, spot: Number(spot.toFixed(2)), expiries, strikes, ltp, iv: 22.0, ivRank: 38 };
        }

        async function getChain(symbol) {
            try {
                const r = await safeFetch(`/api/options/chain/${(symbol||'').toUpperCase()}`);
                if (r && r.success) return r.data;
            } catch {}
            return genChain(symbol || '');
        }

        // Data hooks
        function usePaperData() {
            const [data, setData] = useState({ portfolio: MOCK.portfolio, positions: MOCK.positions, orders: MOCK.orders });
            const [loading, setLoading] = useState(true);

            const refetch = async () => {
                setLoading(true);
                try {
                    const [portfolio, positions, orders] = await Promise.all([
                        safeFetch('/api/papertrade/portfolio').catch(() => MOCK.portfolio),
                        safeFetch('/api/papertrade/positions').catch(() => MOCK.positions),
                        safeFetch('/api/papertrade/orders?limit=20').catch(() => MOCK.orders)
                    ]);
                    setData({ portfolio, positions, orders });
                } catch (e) {
                    console.error('Paper data fetch failed:', e);
                }
                setLoading(false);
            };

            useEffect(() => { 
                console.log('Paper trading page loaded');
                console.log('Loading portfolio data...');
                refetch(); 
            }, []);

            return { ...data, loading, refetch };
        }

        function useAccuracy(instrument, window = '30d') {
            const [acc, setAcc] = useState({ micro: 0, macro: 0, count: 0 });
            useEffect(() => {
                safeFetch(`/api/predictions/accuracy?instrument=${instrument}&window=${window}`)
                    .then(r => setAcc(r.data || acc))
                    .catch(() => {});
            }, [instrument, window]);
            return acc;
        }

        function useActivePredictions() {
            const [preds, setPreds] = useState([]);
            useEffect(() => {
                safeFetch('/api/predictions/active')
                    .then(r => setPreds(r.data || []))
                    .catch(() => {});
            }, []);
            return preds;
        }

        // Components
        function MiniDashboard({ instrument }) {
            const [accType, setAccType] = useState('micro');
            const acc = useAccuracy(instrument);
            const preds = useActivePredictions();
            
            const filtered = preds.filter(p => p.instrument?.toLowerCase() === instrument?.toLowerCase());
            const underMonitor = filtered.filter(p => p.status === 'active').length;
            const met = filtered.filter(p => p.status === 'met').length;
            const notMet = filtered.filter(p => p.status === 'failed').length;

            return (
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                    <div className={clsx(T.surface, T.border, "p-3 rounded")}>
                        <div className="flex items-center justify-between mb-2">
                            <span className={clsx(T.textDim, "text-xs")}>Accuracy</span>
                            <button
                                onClick={() => setAccType(accType === 'micro' ? 'macro' : 'micro')}
                                className="text-xs px-2 py-0.5 bg-blue-500/20 text-blue-300 rounded"
                            >
                                {accType}
                            </button>
                        </div>
                        <div className={clsx(T.text, "text-lg font-semibold")}>
                            {(acc[accType] * 100).toFixed(1)}%
                        </div>
                    </div>
                    
                    <div className={clsx(T.surface, T.border, "p-3 rounded")}>
                        <div className={clsx(T.textDim, "text-xs mb-2")}>Under Monitor</div>
                        <div className={clsx(T.text, "text-lg font-semibold text-yellow-400")}>
                            {underMonitor}
                        </div>
                    </div>
                    
                    <div className={clsx(T.surface, T.border, "p-3 rounded")}>
                        <div className={clsx(T.textDim, "text-xs mb-2")}>Met</div>
                        <div className={clsx(T.text, "text-lg font-semibold text-green-400")}>
                            {met}
                        </div>
                    </div>
                    
                    <div className={clsx(T.surface, T.border, "p-3 rounded")}>
                        <div className={clsx(T.textDim, "text-xs mb-2")}>Not Met</div>
                        <div className={clsx(T.text, "text-lg font-semibold text-red-400")}>
                            {notMet}
                        </div>
                    </div>
                </div>
            );
        }

        function OptionsTab() {
            const [symbol, setSymbol] = useState('RELIANCE');
            const [chain, setChain] = useState(null);
            const [selectedExpiry, setSelectedExpiry] = useState('');
            const [ceStrike, setCeStrike] = useState('');
            const [peStrike, setPeStrike] = useState('');
            const [autoMode, setAutoMode] = useState({ tp: true, sl: true, roi: true, due: true });
            const [manualValues, setManualValues] = useState({ tp: 50, sl: 30, roi: 25, due: todayYMD() });

            useEffect(() => {
                if (symbol) {
                    getChain(symbol).then(c => {
                        setChain(c);
                        setSelectedExpiry(c.expiries[0] || '');
                        const atmStrike = c.strikes.find(s => Math.abs(s - c.spot) === Math.min(...c.strikes.map(st => Math.abs(st - c.spot))));
                        setCeStrike(atmStrike);
                        setPeStrike(atmStrike);
                    });
                }
            }, [symbol]);

            const analytics = useMemo(() => {
                if (!chain || !ceStrike || !peStrike) return {};
                const ceLTP = chain.ltp(ceStrike, 'CE');
                const peLTP = chain.ltp(peStrike, 'PE');
                const netCredit = (ceLTP + peLTP) * chain.lotSize;
                const estMargin = 0.2 * chain.spot * chain.lotSize;
                const roiOnMargin = (netCredit / estMargin) * 100;
                const dte = selectedExpiry ? Math.max(0, Math.floor((new Date(selectedExpiry) - new Date()) / (1000 * 60 * 60 * 24))) : 0;
                const breakevens = [peStrike - (ceLTP + peLTP), ceStrike + (ceLTP + peLTP)];
                
                return {
                    netCredit,
                    estMargin,
                    roiOnMargin,
                    dte,
                    breakevens,
                    iv: chain.iv,
                    ivRank: chain.ivRank
                };
            }, [chain, ceStrike, peStrike, selectedExpiry]);

            return (
                <div>
                    <MiniDashboard instrument="OPTION" />
                    
                    <div className="grid lg:grid-cols-2 gap-6">
                        <div className={clsx(T.surface, T.border, "p-6 rounded")}>
                            <h3 className={clsx(T.text, "text-lg font-semibold mb-4")}>Options Strategy</h3>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className={clsx(T.textDim, "block text-sm mb-1")}>Symbol</label>
                                    <input
                                        type="text"
                                        value={symbol}
                                        onChange={(e) => setSymbol(e.target.value.toUpperCase())}
                                        className={clsx(T.surface, T.border, T.text, "w-full p-2 rounded")}
                                        placeholder="RELIANCE"
                                    />
                                </div>
                                
                                {chain && (
                                    <>
                                        <div>
                                            <label className={clsx(T.textDim, "block text-sm mb-1")}>Expiry</label>
                                            <select
                                                value={selectedExpiry}
                                                onChange={(e) => setSelectedExpiry(e.target.value)}
                                                className={clsx(T.surface, T.border, T.text, "w-full p-2 rounded")}
                                            >
                                                {chain.expiries.map(exp => (
                                                    <option key={exp} value={exp}>{exp}</option>
                                                ))}
                                            </select>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className={clsx(T.textDim, "block text-sm mb-1")}>CE Strike</label>
                                                <select
                                                    value={ceStrike}
                                                    onChange={(e) => setCeStrike(Number(e.target.value))}
                                                    className={clsx(T.surface, T.border, T.text, "w-full p-2 rounded")}
                                                >
                                                    {chain.strikes.map(strike => (
                                                        <option key={strike} value={strike}>{strike}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label className={clsx(T.textDim, "block text-sm mb-1")}>PE Strike</label>
                                                <select
                                                    value={peStrike}
                                                    onChange={(e) => setPeStrike(Number(e.target.value))}
                                                    className={clsx(T.surface, T.border, T.text, "w-full p-2 rounded")}
                                                >
                                                    {chain.strikes.map(strike => (
                                                        <option key={strike} value={strike}>{strike}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                        
                        <div className={clsx(T.surface, T.border, "p-6 rounded")}>
                            <h3 className={clsx(T.text, "text-lg font-semibold mb-4")}>Live Analytics</h3>
                            
                            {analytics.netCredit && (
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div className="flex justify-between">
                                        <span className={T.textDim}>Net Credit:</span>
                                        <span className={T.text}>₹{fmtINR(analytics.netCredit)}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className={T.textDim}>DTE:</span>
                                        <span className={T.text}>{analytics.dte}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className={T.textDim}>IV:</span>
                                        <span className={T.text}>{analytics.iv}%</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className={T.textDim}>IV Rank:</span>
                                        <span className={T.text}>{analytics.ivRank}%</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className={T.textDim}>Est. Margin:</span>
                                        <span className={T.text}>₹{fmtINR(analytics.estMargin)}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className={T.textDim}>ROI on Margin:</span>
                                        <span className={T.text}>{analytics.roiOnMargin.toFixed(1)}%</span>
                                    </div>
                                    <div className="col-span-2">
                                        <span className={T.textDim}>Breakevens:</span>
                                        <span className={T.text}> {analytics.breakevens.map(b => b.toFixed(0)).join(', ')}</span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function EquitiesTab() {
            return (
                <div>
                    <MiniDashboard instrument="EQUITY" />
                    <div className={clsx(T.surface, T.border, "p-6 rounded")}>
                        <h3 className={clsx(T.text, "text-lg font-semibold mb-4")}>Equity Trading</h3>
                        <p className={T.textDim}>Equity trading interface coming soon...</p>
                    </div>
                </div>
            );
        }

        function CommoditiesTab() {
            return (
                <div>
                    <MiniDashboard instrument="COMMODITY" />
                    <div className={clsx(T.surface, T.border, "p-6 rounded")}>
                        <h3 className={clsx(T.text, "text-lg font-semibold mb-4")}>Commodities Trading</h3>
                        <p className={T.textDim}>Commodities trading interface coming soon...</p>
                    </div>
                </div>
            );
        }

        function PaperTrade() {
            const [activeTab, setActiveTab] = useState('options');
            const { portfolio, positions, orders, loading, refetch } = usePaperData();

            const tabs = [
                { id: 'options', label: 'Options', component: OptionsTab },
                { id: 'equities', label: 'Equities', component: EquitiesTab },
                { id: 'commodities', label: 'Commodities', component: CommoditiesTab }
            ];

            const ActiveComponent = tabs.find(t => t.id === activeTab)?.component || OptionsTab;

            return (
                <div className={clsx(T.bg, "min-h-screen p-6")}>
                    <div className="max-w-7xl mx-auto">
                        <div className="flex items-center justify-between mb-6">
                            <h1 className={clsx(T.text, "text-2xl font-bold")}>Paper Trading</h1>
                            <div className={clsx(T.surface, T.border, "px-4 py-2 rounded")}>
                                <span className={T.textDim}>Capital: </span>
                                <span className={T.text}>₹{fmtINR(portfolio.current_capital)}</span>
                            </div>
                        </div>

                        <div className="flex space-x-1 mb-6">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={clsx(
                                        "px-4 py-2 rounded text-sm font-medium transition-colors",
                                        activeTab === tab.id
                                            ? "bg-blue-600 text-white"
                                            : clsx(T.surface, T.text, "hover:bg-white/5")
                                    )}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </div>

                        <ActiveComponent />

                        {positions.length > 0 && (
                            <div className={clsx(T.surface, T.border, "mt-6 p-6 rounded")}>
                                <h3 className={clsx(T.text, "text-lg font-semibold mb-4")}>Current Positions</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className={clsx(T.textDim, "border-b border-white/10")}>
                                                <th className="text-left py-2">Symbol</th>
                                                <th className="text-left py-2">Type</th>
                                                <th className="text-left py-2">Quantity</th>
                                                <th className="text-left py-2">Entry Price</th>
                                                <th className="text-left py-2">Current Price</th>
                                                <th className="text-left py-2">P&L</th>
                                                <th className="text-left py-2">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {positions.map((pos, i) => (
                                                <tr key={i} className={clsx(T.text, "border-b border-white/10")}>
                                                    <td className="py-2">{pos.symbol}</td>
                                                    <td className="py-2">{pos.type}</td>
                                                    <td className="py-2">{pos.quantity}</td>
                                                    <td className="py-2">₹{fmtINR(pos.entry_price)}</td>
                                                    <td className="py-2">₹{fmtINR(pos.current_price)}</td>
                                                    <td className={clsx("py-2", pos.pnl >= 0 ? "text-green-400" : "text-red-400")}>
                                                        ₹{fmtINR(pos.pnl)}
                                                    </td>
                                                    <td className="py-2">
                                                        <button className="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                                            Close
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<PaperTrade />, document.getElementById('root'));
    </script>
</body>
</html>
