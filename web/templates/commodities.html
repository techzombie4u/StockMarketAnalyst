{% extends "_layout.html" %}

{% block title %}Commodities{% endblock %}

{% block content %}
<div class="commodities-container">
    <div class="header-section">
        <h1>Commodities Analysis</h1>
        <div class="analysis-tabs">
            <button class="tab-btn active" data-section="signals">Signals</button>
            <button class="tab-btn" data-section="correlations">Correlations</button>
        </div>
    </div>

    <div id="signals-section" class="analysis-section">
        <h2>Trading Signals</h2>
        <table class="commodities-table">
            <thead>
                <tr>
                    <th>Commodity</th>
                    <th>Signal</th>
                    <th>Strength</th>
                    <th>Price</th>
                    <th>Target</th>
                    <th>Stop Loss</th>
                    <th>Timeframe</th>
                    <th>Confidence</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="signals-body">
                <!-- Data will be loaded via JavaScript -->
            </tbody>
        </table>
    </div>

    <div id="correlations-section" class="analysis-section" style="display: none;">
        <h2>Correlation Matrix</h2>
        <div id="correlation-matrix">
            <!-- Correlation data will be loaded here -->
        </div>
    </div>
</div>

<script>
// Load commodity signals
async function loadCommoditySignals() {
    try {
        const response = await fetch('/api/commodities/signals');
        const data = await response.json();

        const tbody = document.getElementById('signals-body');
        tbody.innerHTML = data.signals.map(signal => `
            <tr>
                <td>${signal.commodity}</td>
                <td><span class="signal ${signal.signal.toLowerCase()}">${signal.signal}</span></td>
                <td>${(signal.strength * 100).toFixed(0)}%</td>
                <td>₹${signal.price.toLocaleString()}</td>
                <td>₹${signal.target.toLocaleString()}</td>
                <td>₹${signal.stop_loss.toLocaleString()}</td>
                <td>${signal.timeframe}</td>
                <td>${(signal.confidence * 100).toFixed(0)}%</td>
                <td>
                    <button class="action-btn">Trade</button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Failed to load commodity signals:', error);
    }
}

// Load correlation matrix
async function loadCorrelations() {
    try {
        const response = await fetch('/api/commodities/correlations');
        const data = await response.json();

        const correlations = data.correlations;
        const commodities = Object.keys(correlations);

        let matrixHTML = '<table class="correlation-table"><thead><tr><th></th>';
        commodities.forEach(commodity => {
            matrixHTML += `<th>${commodity}</th>`;
        });
        matrixHTML += '</tr></thead><tbody>';

        commodities.forEach(rowCommodity => {
            matrixHTML += `<tr><th>${rowCommodity}</th>`;
            commodities.forEach(colCommodity => {
                const correlation = correlations[rowCommodity] && correlations[rowCommodity][colCommodity];
                const value = correlation !== undefined ? correlation.toFixed(2) : (rowCommodity === colCommodity ? '1.00' : '—');
                const cellClass = correlation > 0.5 ? 'positive' : correlation < -0.5 ? 'negative' : 'neutral';
                matrixHTML += `<td class="${cellClass}">${value}</td>`;
            });
            matrixHTML += '</tr>';
        });
        matrixHTML += '</tbody></table>';

        document.getElementById('correlation-matrix').innerHTML = matrixHTML;
    } catch (error) {
        console.error('Failed to load correlations:', error);
    }
}

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Update active tab
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // Show/hide sections
        const section = this.dataset.section;
        document.querySelectorAll('.analysis-section').forEach(s => {
            s.style.display = 'none';
        });
        document.getElementById(`${section}-section`).style.display = 'block';

        // Load appropriate data
        if (section === 'signals') {
            loadCommoditySignals();
        } else if (section === 'correlations') {
            loadCorrelations();
        }
    });
});

// Load data on page load
document.addEventListener('DOMContentLoaded', loadCommoditySignals);
</script>
{% endblock %}